<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UML Diagram Builder</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .visibility-symbol {
            font-family: monospace;
            font-weight: bold;
        }
        
        .preview-box {
            border: 2px solid #3b82f6;
            border-radius: 8px;
            padding: 16px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .preview-section {
            border-top: 1px solid #e5e7eb;
            padding-top: 8px;
            margin-top: 8px;
        }
        
        .note-standard { background-color: #fef3c7; }
        .note-information { background-color: #dbeafe; }
        .note-warning { background-color: #fed7aa; }
        .note-success { background-color: #d1fae5; }
        .note-confirmation { background-color: #cffafe; }
        .note-decorative { background-color: #f3e8ff; }
        
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .error-message {
            background-color: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
            border-radius: 4px;
            padding: 8px 12px;
            margin: 8px 0;
        }
        
        .success-message {
            background-color: #f0fdf4;
            color: #166534;
            border: 1px solid #bbf7d0;
            border-radius: 4px;
            padding: 8px 12px;
            margin: 8px 0;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <div class="max-w-7xl mx-auto p-6">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">UML Diagram Builder</h1>
            <p class="text-gray-600">Create and export UML class diagrams with ease</p>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Main Form Section -->
            <div class="lg:col-span-3">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                    <!-- Header with Controls -->
                    <div class="flex flex-row items-center justify-between p-6 border-b border-gray-200">
                        <h2 class="text-xl font-semibold text-gray-900">Class Definitions</h2>
                        <div class="flex gap-2">
                            <button onclick="addClass()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium flex items-center gap-2">
                                <i class="fas fa-plus"></i>
                                Add Class
                            </button>
                            <button onclick="generateDiagram()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium flex items-center gap-2">
                                <i class="fas fa-image"></i>
                                Generate Diagram
                            </button>
                            <button onclick="exportPlantUML()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md text-sm font-medium flex items-center gap-2">
                                <i class="fas fa-download"></i>
                                Export PlantUML
                            </button>
                        </div>
                    </div>

                    <!-- Messages Area -->
                    <div id="messages" class="px-6"></div>

                    <!-- Classes Container -->
                    <div id="classes-container" class="p-6 space-y-6">
                        <!-- Classes will be dynamically added here -->
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- Styling Controls -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                    <div class="p-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Styling Options</h3>
                    </div>
                    <div class="p-4 space-y-4">
                        <div>
                            <label class="text-sm font-medium text-gray-700 mb-2 block">Box Thickness</label>
                            <input type="range" id="boxThickness" min="1" max="5" value="2" 
                                   class="w-full" onchange="updateStyling()">
                            <div class="text-xs text-gray-500 mt-1">
                                <span id="thicknessValue">2</span>px
                            </div>
                        </div>

                        <div>
                            <label class="text-sm font-medium text-gray-700 mb-2 block">Box Color</label>
                            <select id="boxColor" class="w-full border border-gray-300 rounded-md px-3 py-2" onchange="updateStyling()">
                                <option value="#000000">Black</option>
                                <option value="#3b82f6">Blue</option>
                                <option value="#ef4444">Red</option>
                                <option value="#10b981">Green</option>
                                <option value="#f59e0b">Orange</option>
                                <option value="#8b5cf6">Purple</option>
                                <option value="#6b7280">Gray</option>
                            </select>
                        </div>

                        <!-- Preview Box -->
                        <div>
                            <label class="text-sm font-medium text-gray-700 mb-2 block">Live Preview</label>
                            <div id="stylePreview" class="preview-box">
                                <div class="font-bold text-sm mb-2 text-center">SampleClass</div>
                                <div class="preview-section">
                                    <div class="text-xs font-mono text-gray-700">- name: String</div>
                                    <div class="text-xs font-mono text-gray-700">+ id: int</div>
                                    <div class="text-xs font-mono text-gray-700"># count: int</div>
                                </div>
                                <div class="preview-section">
                                    <div class="text-xs font-mono text-gray-700">+ getName(): String</div>
                                    <div class="text-xs font-mono text-gray-700">+ setName(String): void</div>
                                    <div class="text-xs font-mono text-gray-700">- validateInput(): boolean</div>
                                </div>
                            </div>
                        </div>

                        <!-- Real-time Class Preview -->
                        <div id="liveClassPreview">
                            <label class="text-sm font-medium text-gray-700 mb-2 block">Current Class Preview</label>
                            <div id="currentClassPreview" class="text-xs text-gray-500 italic">
                                Select a class to see preview
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Validation Results -->
                <div id="validationResults" class="bg-white rounded-lg shadow-sm border border-gray-200" style="display: none;">
                    <div class="p-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Validation</h3>
                    </div>
                    <div class="p-4">
                        <div id="validationContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center" style="display: none;">
        <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
            <div class="flex items-center space-x-3">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                <span class="text-gray-700">Processing...</span>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let classes = [];
        let nextId = 1;
        let stylingOptions = {
            outline_color: '#3b82f6',
            outline_width: 2
        };

        // Initialize with example class
        document.addEventListener('DOMContentLoaded', function() {
            addClass({
                name: 'Example Class',
                attributes: [{name: 'name', type: 'string', visibility: 'private'}],
                operations: [{name: 'getName()', visibility: 'public'}],
                notes: [],
                connections: []
            });
            updateStyling();
        });

        // Utility functions
        function generateId() {
            return (nextId++).toString();
        }

        function showMessage(message, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
            messageDiv.textContent = message;
            messagesDiv.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        function showLoading(show = true) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        // Class management functions
        function addClass(initialData = null) {
            const classData = initialData || {
                name: 'New Class',
                attributes: [],
                operations: [],
                notes: [],
                connections: []
            };
            
            classData.id = generateId();
            classes.push(classData);
            renderClasses();
        }

        function removeClass(classId) {
            classes = classes.filter(cls => cls.id !== classId);
            renderClasses();
        }

        function updateClassName(classId, name) {
            const cls = classes.find(c => c.id === classId);
            if (cls) {
                cls.name = name;
                updateConnectionOptions();
            }
        }

        // Note management
        function addNote(classId) {
            const cls = classes.find(c => c.id === classId);
            if (cls) {
                cls.notes.push({
                    id: generateId(),
                    text: '',
                    type: 'Standard'
                });
                renderClasses();
            }
        }

        function updateNote(classId, noteId, field, value) {
            const cls = classes.find(c => c.id === classId);
            if (cls) {
                const note = cls.notes.find(n => n.id === noteId);
                if (note) {
                    note[field] = value;
                }
            }
        }

        function removeNote(classId, noteId) {
            const cls = classes.find(c => c.id === classId);
            if (cls) {
                cls.notes = cls.notes.filter(n => n.id !== noteId);
                renderClasses();
            }
        }

        // Attribute management
        function addAttribute(classId) {
            const cls = classes.find(c => c.id === classId);
            if (cls) {
                cls.attributes.push({
                    id: generateId(),
                    name: 'newAttribute',
                    type: 'string',
                    visibility: 'private'
                });
                renderClasses();
            }
        }

        function updateAttribute(classId, attributeId, field, value) {
            const cls = classes.find(c => c.id === classId);
            if (cls) {
                const attr = cls.attributes.find(a => a.id === attributeId);
                if (attr) {
                    attr[field] = value;
                }
            }
        }

        function removeAttribute(classId, attributeId) {
            const cls = classes.find(c => c.id === classId);
            if (cls) {
                cls.attributes = cls.attributes.filter(a => a.id !== attributeId);
                renderClasses();
            }
        }

        // Operation management
        function addOperation(classId) {
            const cls = classes.find(c => c.id === classId);
            if (cls) {
                cls.operations.push({
                    id: generateId(),
                    name: 'newOperation()',
                    visibility: 'public'
                });
                renderClasses();
            }
        }

        function updateOperation(classId, operationId, field, value) {
            const cls = classes.find(c => c.id === classId);
            if (cls) {
                const op = cls.operations.find(o => o.id === operationId);
                if (op) {
                    op[field] = value;
                }
            }
        }

        function removeOperation(classId, operationId) {
            const cls = classes.find(c => c.id === classId);
            if (cls) {
                cls.operations = cls.operations.filter(o => o.id !== operationId);
                renderClasses();
            }
        }

        // Connection management
        function addConnection(classId) {
            const cls = classes.find(c => c.id === classId);
            if (cls) {
                cls.connections.push({
                    id: generateId(),
                    targetClass: '',
                    relationship: 'association'
                });
                renderClasses();
            }
        }

        function updateConnection(classId, connectionId, field, value) {
            const cls = classes.find(c => c.id === classId);
            if (cls) {
                const conn = cls.connections.find(c => c.id === connectionId);
                if (conn) {
                    conn[field] = value;
                }
            }
        }

        function removeConnection(classId, connectionId) {
            const cls = classes.find(c => c.id === classId);
            if (cls) {
                cls.connections = cls.connections.filter(c => c.id !== connectionId);
                renderClasses();
            }
        }

        // Styling functions
        function updateStyling() {
            const thickness = document.getElementById('boxThickness').value;
            const color = document.getElementById('boxColor').value;
            
            document.getElementById('thicknessValue').textContent = thickness;
            
            const preview = document.getElementById('stylePreview');
            preview.style.borderWidth = thickness + 'px';
            preview.style.borderColor = color;
            
            stylingOptions.outline_width = parseInt(thickness);
            stylingOptions.outline_color = color;
        }

        // Connection options update
        function updateConnectionOptions() {
            const selects = document.querySelectorAll('.target-class-select');
            selects.forEach(select => {
                const currentValue = select.value;
                const currentClassId = select.dataset.classId;
                
                select.innerHTML = '<option value="">Select target class</option>';
                
                classes.forEach(cls => {
                    if (cls.id !== currentClassId) {
                        const option = document.createElement('option');
                        option.value = cls.name;
                        option.textContent = cls.name;
                        if (option.value === currentValue) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    }
                });
            });
        }

        // Main rendering function
        function renderClasses() {
            const container = document.getElementById('classes-container');
            container.innerHTML = '';

            classes.forEach(cls => {
                const classDiv = document.createElement('div');
                classDiv.className = 'border border-gray-200 rounded-lg p-4 space-y-4';
                classDiv.innerHTML = createClassHTML(cls);
                container.appendChild(classDiv);
            });

            updateConnectionOptions();
        }

        function createClassHTML(cls) {
            return `
                <!-- Class Header -->
                <div class="flex items-center justify-between">
                    <input type="text" value="${cls.name}" 
                           onchange="updateClassName('${cls.id}', this.value)"
                           class="text-lg font-semibold max-w-xs border border-gray-300 rounded px-3 py-1"
                           placeholder="Class Name">
                    <button onclick="removeClass('${cls.id}')" 
                            class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>

                <!-- Notes Section -->
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <label class="text-sm font-medium text-gray-600">NOTES</label>
                        <button onclick="addNote('${cls.id}')" 
                                class="bg-gray-500 hover:bg-gray-600 text-white px-2 py-1 rounded text-xs">
                            <i class="fas fa-plus mr-1"></i>Add
                        </button>
                    </div>
                    <div class="space-y-2">
                        ${cls.notes.map(note => createNoteHTML(cls.id, note)).join('')}
                    </div>
                </div>

                <!-- Attributes Section -->
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-medium text-sm text-gray-600">ATTRIBUTES</h4>
                        <button onclick="addAttribute('${cls.id}')" 
                                class="bg-gray-500 hover:bg-gray-600 text-white px-2 py-1 rounded text-xs">
                            <i class="fas fa-plus mr-1"></i>Add
                        </button>
                    </div>
                    <div class="space-y-2">
                        ${cls.attributes.map(attr => createAttributeHTML(cls.id, attr)).join('')}
                    </div>
                </div>

                <!-- Operations Section -->
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-medium text-sm text-gray-600">OPERATIONS</h4>
                        <button onclick="addOperation('${cls.id}')" 
                                class="bg-gray-500 hover:bg-gray-600 text-white px-2 py-1 rounded text-xs">
                            <i class="fas fa-plus mr-1"></i>Add
                        </button>
                    </div>
                    <div class="space-y-2">
                        ${cls.operations.map(op => createOperationHTML(cls.id, op)).join('')}
                    </div>
                </div>

                <!-- Connections Section -->
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-medium text-sm text-gray-600">CONNECTIONS</h4>
                        <button onclick="addConnection('${cls.id}')" 
                                class="bg-gray-500 hover:bg-gray-600 text-white px-2 py-1 rounded text-xs">
                            <i class="fas fa-plus mr-1"></i>Add
                        </button>
                    </div>
                    <div class="space-y-2">
                        ${cls.connections.map(conn => createConnectionHTML(cls.id, conn)).join('')}
                    </div>
                </div>
            `;
        }

        function createNoteHTML(classId, note) {
            return `
                <div class="flex gap-2">
                    <input type="text" value="${note.text}" 
                           onchange="updateNote('${classId}', '${note.id}', 'text', this.value)"
                           placeholder="Add a note for this class..."
                           class="flex-1 border border-gray-300 rounded px-3 py-1">
                    <select onchange="updateNote('${classId}', '${note.id}', 'type', this.value)"
                            class="w-40 border border-gray-300 rounded px-3 py-1">
                        <option value="Standard" ${note.type === 'Standard' ? 'selected' : ''}>Standard</option>
                        <option value="Information" ${note.type === 'Information' ? 'selected' : ''}>Information</option>
                        <option value="Warning" ${note.type === 'Warning' ? 'selected' : ''}>Warning</option>
                        <option value="Success" ${note.type === 'Success' ? 'selected' : ''}>Success</option>
                        <option value="Confirmation" ${note.type === 'Confirmation' ? 'selected' : ''}>Confirmation</option>
                        <option value="Decorative" ${note.type === 'Decorative' ? 'selected' : ''}>Decorative</option>
                    </select>
                    <button onclick="removeNote('${classId}', '${note.id}')" 
                            class="text-red-600 hover:text-red-800 px-2">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        }

        function createAttributeHTML(classId, attr) {
            return `
                <div class="flex items-center gap-2">
                    <select onchange="updateAttribute('${classId}', '${attr.id}', 'visibility', this.value)"
                            class="w-24 border border-gray-300 rounded px-2 py-1">
                        <option value="public" ${attr.visibility === 'public' ? 'selected' : ''}>Public</option>
                        <option value="private" ${attr.visibility === 'private' ? 'selected' : ''}>Private</option>
                        <option value="protected" ${attr.visibility === 'protected' ? 'selected' : ''}>Protected</option>
                    </select>
                    <input type="text" value="${attr.name}" 
                           onchange="updateAttribute('${classId}', '${attr.id}', 'name', this.value)"
                           placeholder="Attribute name"
                           class="flex-1 border border-gray-300 rounded px-3 py-1">
                    <input type="text" value="${attr.type}" 
                           onchange="updateAttribute('${classId}', '${attr.id}', 'type', this.value)"
                           placeholder="Type"
                           class="w-24 border border-gray-300 rounded px-3 py-1">
                    <button onclick="removeAttribute('${classId}', '${attr.id}')" 
                            class="text-red-600 hover:text-red-800 px-2">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        }

        function createOperationHTML(classId, op) {
            return `
                <div class="flex items-center gap-2">
                    <select onchange="updateOperation('${classId}', '${op.id}', 'visibility', this.value)"
                            class="w-24 border border-gray-300 rounded px-2 py-1">
                        <option value="public" ${op.visibility === 'public' ? 'selected' : ''}>Public</option>
                        <option value="private" ${op.visibility === 'private' ? 'selected' : ''}>Private</option>
                        <option value="protected" ${op.visibility === 'protected' ? 'selected' : ''}>Protected</option>
                    </select>
                    <input type="text" value="${op.name}" 
                           onchange="updateOperation('${classId}', '${op.id}', 'name', this.value)"
                           placeholder="Operation name"
                           class="flex-1 border border-gray-300 rounded px-3 py-1">
                    <button onclick="removeOperation('${classId}', '${op.id}')" 
                            class="text-red-600 hover:text-red-800 px-2">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        }

        function createConnectionHTML(classId, conn) {
            return `
                <div class="flex items-center gap-2">
                    <select onchange="updateConnection('${classId}', '${conn.id}', 'targetClass', this.value)"
                            class="target-class-select flex-1 border border-gray-300 rounded px-3 py-1"
                            data-class-id="${classId}">
                        <option value="">Select target class</option>
                    </select>
                    <select onchange="updateConnection('${classId}', '${conn.id}', 'relationship', this.value)"
                            class="w-32 border border-gray-300 rounded px-3 py-1">
                        <option value="inheritance" ${conn.relationship === 'inheritance' ? 'selected' : ''}>Inheritance</option>
                        <option value="association" ${conn.relationship === 'association' ? 'selected' : ''}>Association</option>
                        <option value="aggregation" ${conn.relationship === 'aggregation' ? 'selected' : ''}>Aggregation</option>
                        <option value="composition" ${conn.relationship === 'composition' ? 'selected' : ''}>Composition</option>
                        <option value="dependency" ${conn.relationship === 'dependency' ? 'selected' : ''}>Dependency</option>
                    </select>
                    <button onclick="removeConnection('${classId}', '${conn.id}')" 
                            class="text-red-600 hover:text-red-800 px-2">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        }

        // API functions
        async function generateDiagram() {
            if (classes.length === 0) {
                showMessage('Please add at least one class before generating a diagram.', 'error');
                return;
            }

            showLoading(true);
            
            try {
                const result = await makeApiCall('/api/generate-diagram', {
                    classes: classes,
                    styling: stylingOptions
                });

                if (result.download_url) {
                    showMessage('Diagram generated successfully!', 'success');
                    window.open(result.download_url, '_blank');
                } else if (result.plantuml_code) {
                    showMessage('PlantUML code generated! (Vercel deployment)', 'success');
                    // Create and download PlantUML file
                    const blob = new Blob([result.plantuml_code], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'generated-uml-diagram.puml';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } else {
                    showMessage('Diagram generated successfully!', 'success');
                }
                
            } catch (error) {
                showMessage('Error generating diagram: ' + error.message, 'error');
            }
            
            showLoading(false);
        }

        async function exportPlantUML() {
            if (classes.length === 0) {
                showMessage('Please add at least one class before exporting.', 'error');
                return;
            }

            showLoading(true);
            
            try {
                const result = await makeApiCall('/api/export-plantuml', {
                    classes: classes
                });

                // Create and download file
                const blob = new Blob([result.plantuml_code], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'uml-diagram.puml';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showMessage('PlantUML file exported successfully!', 'success');
                
            } catch (error) {
                showMessage('Error exporting PlantUML: ' + error.message, 'error');
            }
            
            showLoading(false);
        }

        async function validateClasses() {
            if (classes.length === 0) {
                document.getElementById('validationResults').style.display = 'none';
                return;
            }
            
            try {
                const result = await makeApiCall('/api/validate-classes', {
                    classes: classes
                });
                
                displayValidationResults(result);
            } catch (error) {
                console.error('Validation error:', error);
                // Don't show validation errors to user as they're not critical
            }
        }

        function displayValidationResults(result) {
            const validationDiv = document.getElementById('validationResults');
            const contentDiv = document.getElementById('validationContent');
            
            if (result.errors.length === 0 && result.warnings.length === 0) {
                validationDiv.style.display = 'none';
                return;
            }
            
            let content = '';
            
            if (result.errors.length > 0) {
                content += '<div class="mb-4"><h4 class="font-medium text-red-600 mb-2">Errors:</h4><ul class="text-sm text-red-600 space-y-1">';
                result.errors.forEach(error => {
                    content += `<li>• ${error}</li>`;
                });
                content += '</ul></div>';
            }
            
            if (result.warnings.length > 0) {
                content += '<div><h4 class="font-medium text-yellow-600 mb-2">Warnings:</h4><ul class="text-sm text-yellow-600 space-y-1">';
                result.warnings.forEach(warning => {
                    content += `<li>• ${warning}</li>`;
                });
                content += '</ul></div>';
            }
            
            contentDiv.innerHTML = content;
            validationDiv.style.display = 'block';
        }

        // Auto-validate when classes change
        function scheduleValidation() {
            if (window.validationTimeout) {
                clearTimeout(window.validationTimeout);
            }
            window.validationTimeout = setTimeout(validateClasses, 1000);
        }

        // Enhanced error handling for API calls
        async function makeApiCall(url, data) {
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Unknown error occurred');
                }

                return result;
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }

        // Enhanced preview functionality
        function updateLivePreview() {
            if (classes.length === 0) {
                document.getElementById('currentClassPreview').innerHTML = 
                    '<div class="text-xs text-gray-500 italic">No classes to preview</div>';
                return;
            }

            const firstClass = classes[0];
            let previewHTML = `
                <div class="preview-box" style="border-color: ${stylingOptions.outline_color}; border-width: ${stylingOptions.outline_width}px;">
                    <div class="font-bold text-sm mb-2 text-center">${firstClass.name}</div>
            `;

            if (firstClass.attributes && firstClass.attributes.length > 0) {
                previewHTML += '<div class="preview-section">';
                firstClass.attributes.forEach(attr => {
                    const symbol = attr.visibility === 'public' ? '+' : attr.visibility === 'private' ? '-' : '#';
                    previewHTML += `<div class="text-xs font-mono text-gray-700">${symbol} ${attr.name}: ${attr.type}</div>`;
                });
                previewHTML += '</div>';
            }

            if (firstClass.operations && firstClass.operations.length > 0) {
                previewHTML += '<div class="preview-section">';
                firstClass.operations.forEach(op => {
                    const symbol = op.visibility === 'public' ? '+' : op.visibility === 'private' ? '-' : '#';
                    previewHTML += `<div class="text-xs font-mono text-gray-700">${symbol} ${op.name}</div>`;
                });
                previewHTML += '</div>';
            }

            previewHTML += '</div>';
            document.getElementById('currentClassPreview').innerHTML = previewHTML;
        }

        // Override update functions to trigger validation and preview updates
        const originalUpdateClassName = updateClassName;
        updateClassName = function(classId, name) {
            originalUpdateClassName(classId, name);
            scheduleValidation();
            updateLivePreview();
        };

        const originalAddClass = addClass;
        addClass = function(initialData = null) {
            originalAddClass(initialData);
            updateLivePreview();
        };

        const originalRemoveClass = removeClass;
        removeClass = function(classId) {
            originalRemoveClass(classId);
            updateLivePreview();
        };
    </script>
</body>
</html>