<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UML Diagram Builder</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .visibility-symbol {
            font-family: monospace;
            font-weight: bold;
        }
        
        .preview-box {
            border: 2px solid #3b82f6;
            border-radius: 8px;
            padding: 16px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .preview-section {
            border-top: 1px solid #e5e7eb;
            padding-top: 8px;
            margin-top: 8px;
        }
        
        .note-standard { background-color: #fef3c7; }
        .note-information { background-color: #dbeafe; }
        .note-warning { background-color: #fed7aa; }
        .note-success { background-color: #d1fae5; }
        .note-confirmation { background-color: #cffafe; }
        .note-decorative { background-color: #f3e8ff; }
        
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .error-message {
            background-color: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
            border-radius: 4px;
            padding: 8px 12px;
            margin: 8px 0;
        }
        
        .success-message {
            background-color: #f0fdf4;
            color: #166534;
            border: 1px solid #bbf7d0;
            border-radius: 4px;
            padding: 8px 12px;
            margin: 8px 0;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <div class="max-w-7xl mx-auto p-6">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">UML Diagram Builder</h1>
            <p class="text-gray-600">Create and export UML class diagrams with ease</p>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Main Form Section -->
            <div class="lg:col-span-3">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                    <!-- Header with Controls -->
                    <div class="flex flex-row items-center justify-between p-6 border-b border-gray-200">
                        <div class="flex items-center gap-3">
                            <h2 class="text-xl font-semibold text-gray-900">Class Definitions</h2>
                            <div id="saveStatus" class="text-sm text-gray-500 flex items-center gap-1">
                                <i class="fas fa-circle text-green-500" id="saveStatusIcon"></i>
                                <span id="saveStatusText">Auto-save enabled</span>
                            </div>
                        </div>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="addClass()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium flex items-center gap-2">
                                <i class="fas fa-plus"></i>
                                Add Class
                            </button>
                            <button onclick="generateDiagram()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium flex items-center gap-2">
                                <i class="fas fa-download"></i>
                                Generate & Download PNG
                            </button>
                            
                            <!-- Save/Load Controls -->
                            <div class="flex gap-2 border-l border-gray-300 pl-2 ml-2">
                                <button onclick="exportToFile()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md text-sm font-medium flex items-center gap-2">
                                    <i class="fas fa-save"></i>
                                    Export TXT
                                </button>
                                <label for="importFile" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-md text-sm font-medium flex items-center gap-2 cursor-pointer">
                                    <i class="fas fa-upload"></i>
                                    Import TXT
                                </label>
                                <input type="file" id="importFile" accept=".txt,.json" onchange="importFromFile(event)" class="hidden">
                                <button onclick="clearAllData()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm font-medium flex items-center gap-2">
                                    <i class="fas fa-trash"></i>
                                    Clear All
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Messages Area -->
                    <div id="messages" class="px-6"></div>

                    <!-- Classes Container -->
                    <div id="classes-container" class="p-6 space-y-6">
                        <!-- Classes will be dynamically added here -->
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- Styling Controls -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                    <div class="p-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Styling Options</h3>
                    </div>
                    <div class="p-4 space-y-4">
                        <div>
                            <label class="text-sm font-medium text-gray-700 mb-2 block">Box Thickness</label>
                            <input type="range" id="boxThickness" min="1" max="5" value="2" 
                                   class="w-full" onchange="updateStyling()">
                            <div class="text-xs text-gray-500 mt-1">
                                <span id="thicknessValue">2</span>px
                            </div>
                        </div>

                        <div>
                            <label class="text-sm font-medium text-gray-700 mb-2 block">Box Color</label>
                            <select id="boxColor" class="w-full border border-gray-300 rounded-md px-3 py-2" onchange="updateStyling()">
                                <option value="#000000">Black</option>
                                <option value="#3b82f6">Blue</option>
                                <option value="#ef4444">Red</option>
                                <option value="#10b981">Green</option>
                                <option value="#f59e0b">Orange</option>
                                <option value="#8b5cf6">Purple</option>
                                <option value="#6b7280">Gray</option>
                            </select>
                        </div>

                        <!-- Preview Box -->
                        <div>
                            <label class="text-sm font-medium text-gray-700 mb-2 block">Live Preview</label>
                            <div id="stylePreview" class="preview-box">
                                <div class="font-bold text-sm mb-2 text-center">SampleClass</div>
                                <div class="preview-section">
                                    <div class="text-xs font-mono text-gray-700">- name: String</div>
                                    <div class="text-xs font-mono text-gray-700">+ id: int</div>
                                    <div class="text-xs font-mono text-gray-700"># count: int</div>
                                </div>
                                <div class="preview-section">
                                    <div class="text-xs font-mono text-gray-700">+ getName(): String</div>
                                    <div class="text-xs font-mono text-gray-700">+ setName(String): void</div>
                                    <div class="text-xs font-mono text-gray-700">- validateInput(): boolean</div>
                                </div>
                            </div>
                        </div>

                        <!-- Real-time Class Preview -->
                        <div id="liveClassPreview">
                            <label class="text-sm font-medium text-gray-700 mb-2 block">Current Class Preview</label>
                            <div id="currentClassPreview" class="text-xs text-gray-500 italic">
                                Select a class to see preview
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Validation Results -->
                <div id="validationResults" class="bg-white rounded-lg shadow-sm border border-gray-200" style="display: none;">
                    <div class="p-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Validation</h3>
                    </div>
                    <div class="p-4">
                        <div id="validationContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center" style="display: none;">
        <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
            <div class="flex items-center space-x-3">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                <span class="text-gray-700">Processing...</span>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let classes = [];
        let nextId = 1;
        let stylingOptions = {
            outline_color: '#3b82f6',
            outline_width: 2
        };

        // Initialize with example class
        document.addEventListener('DOMContentLoaded', function() {
            addClass({
                name: 'Example Class',
                attributes: [{name: 'name', type: 'string', visibility: 'private'}],
                operations: [{name: 'getName()', visibility: 'public'}],
                notes: [],
                connections: []
            });
            updateStyling();
        });

        // Utility functions
        function generateId() {
            return (nextId++).toString();
        }

        function showMessage(message, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
            messageDiv.textContent = message;
            messagesDiv.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        function showLoading(show = true) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        // Class management functions
        function addClass(initialData = null) {
            const classData = initialData || {
                name: 'New Class',
                attributes: [],
                operations: [],
                notes: [],
                connections: []
            };
            
            classData.id = generateId();
            classes.push(classData);
            renderClasses();
        }

        function removeClass(classId) {
            classes = classes.filter(cls => cls.id !== classId);
            renderClasses();
        }

        function updateClassName(classId, name) {
            const cls = classes.find(c => c.id === classId);
            if (cls) {
                cls.name = name;
                updateConnectionOptions();
            }
        }

        // Note management
        function addNote(classId) {
            const cls = classes.find(c => c.id === classId);
            if (cls) {
                cls.notes.push({
                    id: generateId(),
                    text: '',
                    type: 'Standard'
                });
                renderClasses();
            }
        }

        function updateNote(classId, noteId, field, value) {
            const cls = classes.find(c => c.id === classId);
            if (cls) {
                const note = cls.notes.find(n => n.id === noteId);
                if (note) {
                    note[field] = value;
                }
            }
        }

        function removeNote(classId, noteId) {
            const cls = classes.find(c => c.id === classId);
            if (cls) {
                cls.notes = cls.notes.filter(n => n.id !== noteId);
                renderClasses();
            }
        }

        // Attribute management
        function addAttribute(classId) {
            const cls = classes.find(c => c.id === classId);
            if (cls) {
                cls.attributes.push({
                    id: generateId(),
                    name: 'newAttribute',
                    type: 'string',
                    visibility: 'private'
                });
                renderClasses();
            }
        }

        function updateAttribute(classId, attributeId, field, value) {
            const cls = classes.find(c => c.id === classId);
            if (cls) {
                const attr = cls.attributes.find(a => a.id === attributeId);
                if (attr) {
                    attr[field] = value;
                }
            }
        }

        function removeAttribute(classId, attributeId) {
            const cls = classes.find(c => c.id === classId);
            if (cls) {
                cls.attributes = cls.attributes.filter(a => a.id !== attributeId);
                renderClasses();
            }
        }

        // Operation management
        function addOperation(classId) {
            const cls = classes.find(c => c.id === classId);
            if (cls) {
                cls.operations.push({
                    id: generateId(),
                    name: 'newOperation()',
                    visibility: 'public'
                });
                renderClasses();
            }
        }

        function updateOperation(classId, operationId, field, value) {
            const cls = classes.find(c => c.id === classId);
            if (cls) {
                const op = cls.operations.find(o => o.id === operationId);
                if (op) {
                    op[field] = value;
                }
            }
        }

        function removeOperation(classId, operationId) {
            const cls = classes.find(c => c.id === classId);
            if (cls) {
                cls.operations = cls.operations.filter(o => o.id !== operationId);
                renderClasses();
            }
        }

        // Connection management
        function addConnection(classId) {
            const cls = classes.find(c => c.id === classId);
            if (cls) {
                cls.connections.push({
                    id: generateId(),
                    targetClass: '',
                    relationship: 'association'
                });
                renderClasses();
            }
        }

        function updateConnection(classId, connectionId, field, value) {
            const cls = classes.find(c => c.id === classId);
            if (cls) {
                const conn = cls.connections.find(c => c.id === connectionId);
                if (conn) {
                    conn[field] = value;
                }
            }
        }

        function removeConnection(classId, connectionId) {
            const cls = classes.find(c => c.id === classId);
            if (cls) {
                cls.connections = cls.connections.filter(c => c.id !== connectionId);
                renderClasses();
            }
        }

        // Styling functions
        function updateStyling() {
            const thickness = document.getElementById('boxThickness').value;
            const color = document.getElementById('boxColor').value;
            
            document.getElementById('thicknessValue').textContent = thickness;
            
            const preview = document.getElementById('stylePreview');
            preview.style.borderWidth = thickness + 'px';
            preview.style.borderColor = color;
            
            stylingOptions.outline_width = parseInt(thickness);
            stylingOptions.outline_color = color;
        }

        // Connection options update
        function updateConnectionOptions() {
            const selects = document.querySelectorAll('.target-class-select');
            selects.forEach(select => {
                // Get the current value from either the select value or the data attribute
                const currentValue = select.value || select.dataset.currentValue || '';
                const currentClassId = select.dataset.classId;
                const connectionId = select.dataset.connectionId;
                
                // Clear and rebuild options
                select.innerHTML = '<option value="">Select target class</option>';
                
                // Add options for all other classes
                classes.forEach(cls => {
                    if (cls.id !== currentClassId) {
                        const option = document.createElement('option');
                        option.value = cls.name;
                        option.textContent = cls.name;
                        
                        // Preserve the selection
                        if (option.value === currentValue) {
                            option.selected = true;
                            select.value = currentValue; // Ensure the select shows the right value
                        }
                        
                        select.appendChild(option);
                    }
                });
                
                // Update the data attribute to reflect current state
                select.dataset.currentValue = select.value;
                
                // Most importantly: Update the actual connection data if we have a selection
                if (select.value && currentClassId && connectionId) {
                    updateConnection(currentClassId, connectionId, 'targetClass', select.value);
                }
            });
        }

        // Main rendering function
        function renderClasses() {
            const container = document.getElementById('classes-container');
            container.innerHTML = '';

            classes.forEach(cls => {
                const classDiv = document.createElement('div');
                classDiv.className = 'border border-gray-200 rounded-lg p-4 space-y-4';
                classDiv.innerHTML = createClassHTML(cls);
                container.appendChild(classDiv);
            });

            updateConnectionOptions();
        }

        function createClassHTML(cls) {
            return `
                <!-- Class Header -->
                <div class="flex items-center justify-between">
                    <input type="text" value="${cls.name}" 
                           onchange="updateClassName('${cls.id}', this.value)"
                           class="text-lg font-semibold max-w-xs border border-gray-300 rounded px-3 py-1"
                           placeholder="Class Name">
                    <button onclick="removeClass('${cls.id}')" 
                            class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>

                <!-- Notes Section -->
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <label class="text-sm font-medium text-gray-600">NOTES</label>
                        <button onclick="addNote('${cls.id}')" 
                                class="bg-gray-500 hover:bg-gray-600 text-white px-2 py-1 rounded text-xs">
                            <i class="fas fa-plus mr-1"></i>Add
                        </button>
                    </div>
                    <div class="space-y-2">
                        ${cls.notes.map(note => createNoteHTML(cls.id, note)).join('')}
                    </div>
                </div>

                <!-- Attributes Section -->
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-medium text-sm text-gray-600">ATTRIBUTES</h4>
                        <button onclick="addAttribute('${cls.id}')" 
                                class="bg-gray-500 hover:bg-gray-600 text-white px-2 py-1 rounded text-xs">
                            <i class="fas fa-plus mr-1"></i>Add
                        </button>
                    </div>
                    <div class="space-y-2">
                        ${cls.attributes.map(attr => createAttributeHTML(cls.id, attr)).join('')}
                    </div>
                </div>

                <!-- Operations Section -->
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-medium text-sm text-gray-600">OPERATIONS</h4>
                        <button onclick="addOperation('${cls.id}')" 
                                class="bg-gray-500 hover:bg-gray-600 text-white px-2 py-1 rounded text-xs">
                            <i class="fas fa-plus mr-1"></i>Add
                        </button>
                    </div>
                    <div class="space-y-2">
                        ${cls.operations.map(op => createOperationHTML(cls.id, op)).join('')}
                    </div>
                </div>

                <!-- Connections Section -->
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-medium text-sm text-gray-600">CONNECTIONS</h4>
                        <button onclick="addConnection('${cls.id}')" 
                                class="bg-gray-500 hover:bg-gray-600 text-white px-2 py-1 rounded text-xs">
                            <i class="fas fa-plus mr-1"></i>Add
                        </button>
                    </div>
                    <div class="space-y-2">
                        ${cls.connections.map(conn => createConnectionHTML(cls.id, conn)).join('')}
                    </div>
                </div>
            `;
        }

        function createNoteHTML(classId, note) {
            return `
                <div class="flex gap-2">
                    <input type="text" value="${note.text}" 
                           onchange="updateNote('${classId}', '${note.id}', 'text', this.value)"
                           placeholder="Add a note for this class..."
                           class="flex-1 border border-gray-300 rounded px-3 py-1">
                    <select onchange="updateNote('${classId}', '${note.id}', 'type', this.value)"
                            class="w-40 border border-gray-300 rounded px-3 py-1">
                        <option value="Standard" ${note.type === 'Standard' ? 'selected' : ''}>Standard</option>
                        <option value="Information" ${note.type === 'Information' ? 'selected' : ''}>Information</option>
                        <option value="Warning" ${note.type === 'Warning' ? 'selected' : ''}>Warning</option>
                        <option value="Success" ${note.type === 'Success' ? 'selected' : ''}>Success</option>
                        <option value="Confirmation" ${note.type === 'Confirmation' ? 'selected' : ''}>Confirmation</option>
                        <option value="Decorative" ${note.type === 'Decorative' ? 'selected' : ''}>Decorative</option>
                    </select>
                    <button onclick="removeNote('${classId}', '${note.id}')" 
                            class="text-red-600 hover:text-red-800 px-2">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        }

        function createAttributeHTML(classId, attr) {
            return `
                <div class="flex items-center gap-2">
                    <select onchange="updateAttribute('${classId}', '${attr.id}', 'visibility', this.value)"
                            class="w-24 border border-gray-300 rounded px-2 py-1">
                        <option value="public" ${attr.visibility === 'public' ? 'selected' : ''}>Public</option>
                        <option value="private" ${attr.visibility === 'private' ? 'selected' : ''}>Private</option>
                        <option value="protected" ${attr.visibility === 'protected' ? 'selected' : ''}>Protected</option>
                    </select>
                    <input type="text" value="${attr.name}" 
                           onchange="updateAttribute('${classId}', '${attr.id}', 'name', this.value)"
                           placeholder="Attribute name"
                           class="flex-1 border border-gray-300 rounded px-3 py-1">
                    <input type="text" value="${attr.type}" 
                           onchange="updateAttribute('${classId}', '${attr.id}', 'type', this.value)"
                           placeholder="Type"
                           class="w-24 border border-gray-300 rounded px-3 py-1">
                    <button onclick="removeAttribute('${classId}', '${attr.id}')" 
                            class="text-red-600 hover:text-red-800 px-2">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        }

        function createOperationHTML(classId, op) {
            return `
                <div class="flex items-center gap-2">
                    <select onchange="updateOperation('${classId}', '${op.id}', 'visibility', this.value)"
                            class="w-24 border border-gray-300 rounded px-2 py-1">
                        <option value="public" ${op.visibility === 'public' ? 'selected' : ''}>Public</option>
                        <option value="private" ${op.visibility === 'private' ? 'selected' : ''}>Private</option>
                        <option value="protected" ${op.visibility === 'protected' ? 'selected' : ''}>Protected</option>
                    </select>
                    <input type="text" value="${op.name}" 
                           onchange="updateOperation('${classId}', '${op.id}', 'name', this.value)"
                           placeholder="Operation name"
                           class="flex-1 border border-gray-300 rounded px-3 py-1">
                    <button onclick="removeOperation('${classId}', '${op.id}')" 
                            class="text-red-600 hover:text-red-800 px-2">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        }

        function createConnectionHTML(classId, conn) {
            return `
                <div class="flex items-center gap-2">
                    <select onchange="updateConnection('${classId}', '${conn.id}', 'targetClass', this.value)"
                            class="target-class-select flex-1 border border-gray-300 rounded px-3 py-1"
                            data-class-id="${classId}"
                            data-connection-id="${conn.id}"
                            data-current-value="${conn.targetClass || ''}">
                        <option value="">Select target class</option>
                    </select>
                    <select onchange="updateConnection('${classId}', '${conn.id}', 'relationship', this.value)"
                            class="w-32 border border-gray-300 rounded px-3 py-1">
                        <option value="inheritance" ${conn.relationship === 'inheritance' ? 'selected' : ''}>Inheritance</option>
                        <option value="association" ${conn.relationship === 'association' ? 'selected' : ''}>Association</option>
                        <option value="aggregation" ${conn.relationship === 'aggregation' ? 'selected' : ''}>Aggregation</option>
                        <option value="composition" ${conn.relationship === 'composition' ? 'selected' : ''}>Composition</option>
                        <option value="dependency" ${conn.relationship === 'dependency' ? 'selected' : ''}>Dependency</option>
                    </select>
                    <button onclick="removeConnection('${classId}', '${conn.id}')" 
                            class="text-red-600 hover:text-red-800 px-2">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        }

        // API functions
        async function generateDiagram() {
            if (classes.length === 0) {
                showMessage('Please add at least one class before generating a diagram.', 'error');
                return;
            }

            showLoading(true);
            
            try {
                // Debug: Log what we're sending
                console.log('Sending classes data:', JSON.stringify(classes, null, 2));
                console.log('Sending styling options:', JSON.stringify(stylingOptions, null, 2));
                
                const result = await makeApiCall('/api/generate-diagram', {
                    classes: classes,
                    styling: stylingOptions
                });

                if (result.download_url) {
                    // Local development with full image generation
                    showMessage('Diagram generated successfully!', 'success');
                    window.open(result.download_url, '_blank');
                } else if (result.image_data) {
                    // Vercel deployment with base64 PNG data
                    showMessage('Diagram generated successfully!', 'success');
                    
                    // Debug: Log the received data
                    console.log('Received image_data:', result.image_data.substring(0, 100) + '...');
                    console.log('Image data length:', result.image_data.length);
                    
                    // Handle both data URL format and plain base64
                    let base64Data = result.image_data;
                    if (base64Data.startsWith('data:image/png;base64,')) {
                        console.log('Data URL format detected, extracting base64 part');
                        base64Data = base64Data.split(',')[1];
                    } else {
                        console.log('Plain base64 format detected');
                    }
                    
                    console.log('Final base64 data length:', base64Data.length);
                    
                    // Convert base64 to blob and download
                    try {
                        const byteCharacters = atob(base64Data);
                        const byteNumbers = new Array(byteCharacters.length);
                        for (let i = 0; i < byteCharacters.length; i++) {
                            byteNumbers[i] = byteCharacters.charCodeAt(i);
                        }
                        const byteArray = new Uint8Array(byteNumbers);
                        const blob = new Blob([byteArray], { type: 'image/png' });
                        
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'uml-diagram.png';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    } catch (decodeError) {
                        console.error('Base64 decode error:', decodeError);
                        console.error('Problematic base64 data:', base64Data.substring(0, 200));
                        showMessage('Error decoding image data: ' + decodeError.message, 'error');
                        return;
                    }
                } else {
                    showMessage('Diagram generated successfully!', 'success');
                }
                
            } catch (error) {
                showMessage('Error generating diagram: ' + error.message, 'error');
            }
            
            showLoading(false);
        }



        async function validateClasses() {
            if (classes.length === 0) {
                document.getElementById('validationResults').style.display = 'none';
                return;
            }
            
            try {
                const result = await makeApiCall('/api/validate-classes', {
                    classes: classes
                });
                
                displayValidationResults(result);
            } catch (error) {
                console.error('Validation error:', error);
                // Don't show validation errors to user as they're not critical
            }
        }

        function displayValidationResults(result) {
            const validationDiv = document.getElementById('validationResults');
            const contentDiv = document.getElementById('validationContent');
            
            if (result.errors.length === 0 && result.warnings.length === 0) {
                validationDiv.style.display = 'none';
                return;
            }
            
            let content = '';
            
            if (result.errors.length > 0) {
                content += '<div class="mb-4"><h4 class="font-medium text-red-600 mb-2">Errors:</h4><ul class="text-sm text-red-600 space-y-1">';
                result.errors.forEach(error => {
                    content += `<li>• ${error}</li>`;
                });
                content += '</ul></div>';
            }
            
            if (result.warnings.length > 0) {
                content += '<div><h4 class="font-medium text-yellow-600 mb-2">Warnings:</h4><ul class="text-sm text-yellow-600 space-y-1">';
                result.warnings.forEach(warning => {
                    content += `<li>• ${warning}</li>`;
                });
                content += '</ul></div>';
            }
            
            contentDiv.innerHTML = content;
            validationDiv.style.display = 'block';
        }

        // Auto-validate when classes change
        function scheduleValidation() {
            if (window.validationTimeout) {
                clearTimeout(window.validationTimeout);
            }
            window.validationTimeout = setTimeout(validateClasses, 1000);
        }

        // Enhanced error handling for API calls
        async function makeApiCall(url, data) {
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Unknown error occurred');
                }

                return result;
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }

        // Enhanced preview functionality
        function updateLivePreview() {
            if (classes.length === 0) {
                document.getElementById('currentClassPreview').innerHTML = 
                    '<div class="text-xs text-gray-500 italic">No classes to preview</div>';
                return;
            }

            const firstClass = classes[0];
            let previewHTML = `
                <div class="preview-box" style="border-color: ${stylingOptions.outline_color}; border-width: ${stylingOptions.outline_width}px;">
                    <div class="font-bold text-sm mb-2 text-center">${firstClass.name}</div>
            `;

            if (firstClass.attributes && firstClass.attributes.length > 0) {
                previewHTML += '<div class="preview-section">';
                firstClass.attributes.forEach(attr => {
                    const symbol = attr.visibility === 'public' ? '+' : attr.visibility === 'private' ? '-' : '#';
                    previewHTML += `<div class="text-xs font-mono text-gray-700">${symbol} ${attr.name}: ${attr.type}</div>`;
                });
                previewHTML += '</div>';
            }

            if (firstClass.operations && firstClass.operations.length > 0) {
                previewHTML += '<div class="preview-section">';
                firstClass.operations.forEach(op => {
                    const symbol = op.visibility === 'public' ? '+' : op.visibility === 'private' ? '-' : '#';
                    previewHTML += `<div class="text-xs font-mono text-gray-700">${symbol} ${op.name}</div>`;
                });
                previewHTML += '</div>';
            }

            previewHTML += '</div>';
            document.getElementById('currentClassPreview').innerHTML = previewHTML;
        }

        // Override update functions to trigger validation and preview updates
        const originalUpdateClassName = updateClassName;
        updateClassName = function(classId, name) {
            originalUpdateClassName(classId, name);
            scheduleValidation();
            updateLivePreview();
        };

        const originalAddClass = addClass;
        addClass = function(initialData = null) {
            originalAddClass(initialData);
            updateLivePreview();
        };

        const originalRemoveClass = removeClass;
        removeClass = function(classId) {
            originalRemoveClass(classId);
            updateLivePreview();
        };

        // Save/Load functionality
        const SAVE_KEY = 'uml_generator_save_data';
        
        // Cookie management functions
        function setCookie(name, value, days = 30) {
            const expires = new Date();
            expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = `${name}=${encodeURIComponent(JSON.stringify(value))};expires=${expires.toUTCString()};path=/`;
        }
        
        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) {
                    try {
                        return JSON.parse(decodeURIComponent(c.substring(nameEQ.length, c.length)));
                    } catch (e) {
                        return null;
                    }
                }
            }
            return null;
        }
        
        function deleteCookie(name) {
            document.cookie = name + '=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
        }
        
        // Auto-save to cookies
        function autoSaveToCookies() {
            const saveData = {
                classes: classes,
                styling: stylingOptions,
                timestamp: new Date().toISOString()
            };
            
            setCookie(SAVE_KEY, saveData);
            console.log('Auto-saved to cookies at:', saveData.timestamp);
            
            // Update save status
            updateSaveStatus('Saved at ' + new Date().toLocaleTimeString(), 'success');
        }
        
        // Update save status indicator
        function updateSaveStatus(message, type = 'info') {
            const statusIcon = document.getElementById('saveStatusIcon');
            const statusText = document.getElementById('saveStatusText');
            
            if (statusIcon && statusText) {
                statusText.textContent = message;
                
                // Update icon color based on type
                statusIcon.className = 'fas fa-circle ' + 
                    (type === 'success' ? 'text-green-500' : 
                     type === 'error' ? 'text-red-500' : 
                     type === 'warning' ? 'text-yellow-500' : 'text-blue-500');
                
                // Reset to default after 3 seconds
                if (type !== 'info') {
                    setTimeout(() => {
                        statusIcon.className = 'fas fa-circle text-green-500';
                        statusText.textContent = 'Auto-save enabled';
                    }, 3000);
                }
            }
        }
        
        // Load from cookies
        function loadFromCookies() {
            const savedData = getCookie(SAVE_KEY);
            if (savedData && savedData.classes) {
                classes = savedData.classes;
                if (savedData.styling) {
                    stylingOptions = { ...stylingOptions, ...savedData.styling };
                    // Update UI styling controls
                    updateStylingControls();
                }
                renderClasses();
                updateLivePreview();
                showMessage(`Restored data from ${new Date(savedData.timestamp).toLocaleString()}`, 'success');
                return true;
            }
            return false;
        }
        
        function updateStylingControls() {
            if (document.getElementById('boxThickness')) {
                document.getElementById('boxThickness').value = stylingOptions.outline_width;
                document.getElementById('thicknessValue').textContent = stylingOptions.outline_width;
            }
            if (document.getElementById('boxColor')) {
                document.getElementById('boxColor').value = stylingOptions.outline_color;
            }
            updateStyling(); // Update the preview
        }
        
        // Export to TXT file
        function exportToFile() {
            const exportData = {
                version: "1.0",
                created: new Date().toISOString(),
                classes: classes,
                styling: stylingOptions
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'text/plain' });
            
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `uml_diagram_${new Date().toISOString().slice(0, 16).replace(/:/g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage('Diagram exported to file!', 'success');
        }
        
        // Import from file
        function importFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    // Validate import data
                    if (!importData.classes || !Array.isArray(importData.classes)) {
                        throw new Error('Invalid file format: missing classes data');
                    }
                    
                    // Load data
                    classes = importData.classes;
                    if (importData.styling) {
                        stylingOptions = { ...stylingOptions, ...importData.styling };
                        updateStylingControls();
                    }
                    
                    renderClasses();
                    updateLivePreview();
                    autoSaveToCookies(); // Auto-save the imported data
                    
                    const importDate = importData.created ? 
                        new Date(importData.created).toLocaleString() : 
                        'unknown date';
                    showMessage(`Successfully imported diagram from ${importDate}`, 'success');
                    
                } catch (error) {
                    showMessage(`Import failed: ${error.message}`, 'error');
                }
                
                // Reset file input
                event.target.value = '';
            };
            reader.readAsText(file);
        }
        
        // Clear all data
        function clearAllData() {
            if (confirm('Are you sure you want to clear all classes and data? This action cannot be undone.')) {
                classes = [];
                renderClasses();
                updateLivePreview();
                deleteCookie(SAVE_KEY);
                showMessage('All data cleared!', 'success');
            }
        }
        
        // Auto-save trigger - save whenever data changes
        function triggerAutoSave() {
            // Show pending save status
            updateSaveStatus('Saving...', 'warning');
            
            // Debounce auto-save to avoid excessive saves
            if (window.autoSaveTimeout) {
                clearTimeout(window.autoSaveTimeout);
            }
            window.autoSaveTimeout = setTimeout(autoSaveToCookies, 2000); // Save after 2 seconds of inactivity
        }
        
        // Integrate auto-save with existing functions
        const originalAddClass2 = addClass;
        addClass = function(initialData = null) {
            originalAddClass2(initialData);
            triggerAutoSave();
        };
        
        const originalRemoveClass2 = removeClass;
        removeClass = function(classId) {
            originalRemoveClass2(classId);
            triggerAutoSave();
        };
        
        const originalUpdateClassName2 = updateClassName;
        updateClassName = function(classId, name) {
            originalUpdateClassName2(classId, name);
            triggerAutoSave();
        };
        
        const originalUpdateConnection2 = updateConnection;
        updateConnection = function(classId, connectionId, field, value) {
            originalUpdateConnection2(classId, connectionId, field, value);
            triggerAutoSave();
        };
        
        const originalUpdateStyling = updateStyling;
        updateStyling = function() {
            originalUpdateStyling();
            triggerAutoSave();
        };
        
        // Initialize the app and load saved data on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Try to load saved data from cookies
            if (!loadFromCookies()) {
                console.log('No saved data found in cookies, starting fresh');
            }
            
            // Set up periodic auto-save (every 5 minutes as backup)
            setInterval(autoSaveToCookies, 5 * 60 * 1000);
        });
    </script>
</body>
</html>